{% extends 'encomendas/base.html' %}
{% block title %}{{ title }} - Sistema de Encomendas{% endblock %}

{% block extra_css %}
<style>
    .item-form { 
        background-color: #f8f9fa; 
    }
    .calculated-field { 
        background-color: #e9ecef; 
        font-weight: bold; 
    }
    /* Estilos para destacar campos com erro */
    .is-invalid { 
        border-color: #dc3545 !important; 
    }
    .invalid-feedback { 
        display: block; 
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-clipboard-plus me-3"></i>{{ title }}</h1>
</div>

<form method="post" id="encomendaForm">
    {% csrf_token %}
    
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Dados da Encomenda</h5></div>
        <div class="card-body">
            {% if form.non_field_errors %}
                <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.cliente.id_for_label }}" class="form-label">{{ form.cliente.label }}</label>
                    {{ form.cliente }}
                    {% for error in form.cliente.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                </div>
                {% if encomenda and form.status %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                    {{ form.status }}
                    {% for error in form.status.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.data_prevista_entrega.id_for_label }}" class="form-label">{{ form.data_prevista_entrega.label }}</label>
                    {{ form.data_prevista_entrega }}
                    {% for error in form.data_prevista_entrega.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.valor_pago_adiantamento.id_for_label }}" class="form-label">{{ form.valor_pago_adiantamento.label }}</label>
                    {{ form.valor_pago_adiantamento }}
                    {% for error in form.valor_pago_adiantamento.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-12 mb-3">
                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">{{ form.observacoes.label }}</label>
                    {{ form.observacoes }}
                    {% for error in form.observacoes.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    {% if encomenda and entrega_form %}
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Dados da Execução da Entrega</h5></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3"><label for="{{ entrega_form.responsavel_entrega.id_for_label }}">{{ entrega_form.responsavel_entrega.label }}</label>{{ entrega_form.responsavel_entrega }}</div>
                <div class="col-md-6 mb-3"><label for="{{ entrega_form.entregue_por.id_for_label }}">{{ entrega_form.entregue_por.label }}</label>{{ entrega_form.entregue_por }}</div>
                <div class="col-md-6 mb-3"><label for="{{ entrega_form.data_entrega_realizada.id_for_label }}">{{ entrega_form.data_entrega_realizada.label }}</label>{{ entrega_form.data_entrega_realizada }}</div>
                <div class="col-md-6 mb-3"><label for="{{ entrega_form.hora_entrega.id_for_label }}">{{ entrega_form.hora_entrega.label }}</label>{{ entrega_form.hora_entrega }}</div>
                <div class="col-12 mb-3"><label for="{{ entrega_form.assinatura_cliente.id_for_label }}">{{ entrega_form.assinatura_cliente.label }}</label>{{ entrega_form.assinatura_cliente }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header"><h5 class="mb-0">Itens da Encomenda</h5></div>
        <div class="card-body">
            {{ formset.management_form }}
            {% if formset.non_form_errors %}
                <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
            {% endif %}
            <div id="formset-container">
                {% for item_form in formset %}
                <div class="item-form border rounded p-3 mb-3 position-relative" id="item-{{ forloop.counter0 }}">
                    <button type="button" class="btn-close position-absolute top-0 end-0 p-2 delete-form" aria-label="Close"></button>
                    {{ item_form.DELETE }}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ item_form.produto.id_for_label }}">{{ item_form.produto.label }}</label>
                            {{ item_form.produto }}
                            {% for error in item_form.produto.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ item_form.fornecedor.id_for_label }}">{{ item_form.fornecedor.label }}</label>
                            {{ item_form.fornecedor }}
                            {% for error in item_form.fornecedor.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label for="{{ item_form.quantidade.id_for_label }}">{{ item_form.quantidade.label }}</label>{{ item_form.quantidade }}{% for error in item_form.quantidade.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}</div>
                        <div class="col-md-3 mb-3"><label>Preço Base (R$)</label><input type="text" class="form-control calculated-field" id="id_preco_base_{{ forloop.counter0 }}" readonly></div>
                        <div class="col-md-3 mb-3"><label for="{{ item_form.preco_cotado.id_for_label }}">{{ item_form.preco_cotado.label }}</label>{{ item_form.preco_cotado }}{% for error in item_form.preco_cotado.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}</div>
                        <div class="col-md-3 mb-3"><label for="{{ item_form.observacoes.id_for_label }}">{{ item_form.observacoes.label }}</label>{{ item_form.observacoes }}{% for error in item_form.observacoes.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}</div>
                    </div>
                    {% for hidden in item_form.hidden_fields %}{% if "DELETE" not in hidden.name %}{{ hidden }}{% endif %}{% endfor %}
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-success" id="add-form">Adicionar Item</button>
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-between">
        <a href="{% url 'encomenda_list' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar Encomenda</button>
    </div>
</form>

<div id="empty-form" style="display: none;">
    <div class="item-form border rounded p-3 mb-3 position-relative" id="item-__prefix__">
        <button type="button" class="btn-close position-absolute top-0 end-0 p-2 delete-form" aria-label="Close"></button>
        {{ formset.empty_form.DELETE }}
        <div class="row">
            <div class="col-md-6 mb-3"><label for="id_itens-__prefix__-produto">Produto</label>{{ formset.empty_form.produto }}</div>
            <div class="col-md-6 mb-3"><label for="id_itens-__prefix__-fornecedor">Fornecedor</label>{{ formset.empty_form.fornecedor }}</div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-3"><label for="id_itens-__prefix__-quantidade">Quantidade</label>{{ formset.empty_form.quantidade }}</div>
            <div class="col-md-3 mb-3"><label>Preço Base (R$)</label><input type="text" class="form-control calculated-field" id="id_preco_base___prefix__" readonly></div>
            <div class="col-md-3 mb-3"><label for="id_itens-__prefix__-preco_cotado">Preço Cotado</label>{{ formset.empty_form.preco_cotado }}</div>
            <div class="col-md-3 mb-3"><label for="id_itens-__prefix__-observacoes">Observações</label>{{ formset.empty_form.observacoes }}</div>
        </div>
        {% for hidden in formset.empty_form.hidden_fields %}{% if "DELETE" not in hidden.name %}{{ hidden }}{% endif %}{% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalFormsInput = document.getElementById('id_itens-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty-form').innerHTML;

    function updateFormIndexes() {
        formsetContainer.querySelectorAll('.item-form').forEach((form, index) => {
            form.id = `item-${index}`;
            form.querySelectorAll('input, select, textarea').forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    input.name = name.replace(/-\d+-/, `-${index}-`);
                }
                const id = input.getAttribute('id');
                if (id) {
                    input.id = id.replace(/_\d+_/, `_${index}_`).replace(/-\d+-/, `-${index}-`);
                }
            });
             form.querySelectorAll('label').forEach(label => {
                const forAttr = label.getAttribute('for');
                if (forAttr) {
                    label.setAttribute('for', forAttr.replace(/-\d+-/, `-${index}-`));
                }
            });
        });
    }
    
    function addForm() {
        let formCount = parseInt(totalFormsInput.value);
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
        formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = formCount + 1;
        updateFormIndexes();
    }

    addButton.addEventListener('click', addForm);

    formsetContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-form')) {
            const formElement = e.target.closest('.item-form');
            const deleteInput = formElement.querySelector('input[name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
                formElement.style.display = 'none';
            }
        }
    });

    document.body.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('produto-select')) {
            const produtoId = e.target.value;
            const formElement = e.target.closest('.item-form');
            const formIndex = formElement.id.split('-')[1];
            
            const precoBaseInput = document.getElementById(`id_preco_base_${formIndex}`);
            const precoCotadoInput = document.getElementById(`id_itens-${formIndex}-preco_cotado`);

            if (produtoId && precoBaseInput) {
                fetch(`/api/produto/${produtoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.preco_base) {
                            precoBaseInput.value = parseFloat(data.preco_base).toFixed(2);
                            if (precoCotadoInput) {
                                precoCotadoInput.value = '';
                                precoCotadoInput.placeholder = 'Preencha o valor';
                            }
                        }
                    })
                    .catch(error => console.error('Erro:', error));
            } else if (precoBaseInput) {
                precoBaseInput.value = '';
                if (precoCotadoInput) precoCotadoInput.value = '';
            }
        }
    });
});
</script>
{% endblock %}